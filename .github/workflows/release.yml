# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v1
      with:
        versionSpec: '5.x'

    - name: Run GitVersion
      id: gitversion
      uses: gittools/actions/gitversion/execute@v1

    - name: Restore dependencies
      run: dotnet restore OTAPI.UnifiedServerProcess/src/OTAPI.UnifiedServerProcess/OTAPI.UnifiedServerProcess.csproj

    - name: Build project with version
      run: >
        dotnet build OTAPI.UnifiedServerProcess/src/OTAPI.UnifiedServerProcess/OTAPI.UnifiedServerProcess.csproj
        --configuration Release
        /p:GitVersion_NuGetVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
        /p:GitVersion_AssemblySemVer=${{ steps.gitversion.outputs.assemblySemVer }}
        /p:GitVersion_AssemblySemFileVer=${{ steps.gitversion.outputs.assemblySemFileVer }}
        /p:GitVersion_InformationalVersion=${{ steps.gitversion.outputs.informationalVersion }}

    - name: Run compiled EXE
      run: |
        cd OTAPI.UnifiedServerProcess/src/OTAPI.UnifiedServerProcess/bin/Release/net9.0
        .\OTAPI.UnifiedServerProcess.exe

    - name: Create output zip file
      run: |
        $version = "${{ steps.gitversion.outputs.nuGetVersionV2 }}"
        $outputDir = "OTAPI.UnifiedServerProcess/src/OTAPI.UnifiedServerProcess/bin/Release/net9.0/output"
        $zipPath = "UnifiedServerProcess-v$version.zip"
        Compress-Archive -Path "$outputDir\*" -DestinationPath "$zipPath"
        echo "Created zip at $zipPath"

    - name: Upload ZIP as Release asset
      uses: softprops/action-gh-release@v2
      with:
        files: UnifiedServerProcess-v${{ steps.gitversion.outputs.nuGetVersionV2 }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
